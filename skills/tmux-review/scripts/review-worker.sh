#!/bin/bash
set -euo pipefail

# ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ã®ç¢ºèª
worker_info_file="${CLAUDE_PROJECT_DIR}/.claude/worker-info"
if [ ! -f "$worker_info_file" ]; then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
  echo "/tmux-worker ã‚¹ã‚­ãƒ«ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
  exit 1
fi

# ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
# shellcheck source=/dev/null
source "$worker_info_file"

if [ -z "${CLAUDE_WORKER_SESSION:-}" ] || [ -z "${CLAUDE_WORKER_WINDOW:-}" ] || [ -z "${CLAUDE_WORKER_PANE:-}" ]; then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ãŒä¸æ­£ã§ã™" >&2
  echo "worker-infoã®å†…å®¹:" >&2
  cat "$worker_info_file" >&2
  exit 1
fi

session="${CLAUDE_WORKER_SESSION}"
tmux_target="${session}:${CLAUDE_WORKER_WINDOW}.${CLAUDE_WORKER_PANE}"

echo "ðŸ“Š ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ä¸­..." >&2
echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${tmux_target}" >&2
echo "" >&2

# ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
if ! output=$(tmux capture-pane -t "${tmux_target}" -p -S -3000 2>&1); then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³ã®å‡ºåŠ›ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
  echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${tmux_target}" >&2
  echo "$output" >&2
  exit 1
fi

# å‡ºåŠ›ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆSCRATCHPAD_DIRã‚’ä½¿ç”¨ï¼‰
output_file="${SCRATCHPAD_DIR}/worker-output-$(date +%s).txt"
echo "$output" > "$output_file"

echo "âœ… ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å‡ºåŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${output_file}" >&2
echo "" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å‡ºåŠ›:" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "$output"
echo "" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "ðŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "" >&2
echo "å…±é€šãƒã‚§ãƒƒã‚¯é …ç›®:" >&2
echo "- [ ] ã‚¿ã‚¹ã‚¯ã®ç›®çš„ãŒé”æˆã•ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] è¦ä»¶ãŒã™ã¹ã¦æº€ãŸã•ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] åˆ¶ç´„æ¡ä»¶ãŒå®ˆã‚‰ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] ã‚³ãƒ¼ãƒ‰ã®å“è³ªï¼ˆå¯èª­æ€§ã€ä¿å®ˆæ€§ï¼‰ã¯é©åˆ‡ã‹" >&2
echo "- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] TypeScriptåž‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹" >&2
echo "- [ ] ESLintã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹" >&2
echo "- [ ] ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ã‹" >&2
echo "" >&2
echo "ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¥ãƒã‚§ãƒƒã‚¯:" >&2
echo "" >&2
echo "ã€æ©Ÿèƒ½è¿½åŠ ã®å ´åˆã€‘" >&2
echo "- [ ] æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãŒãªã„ã‹" >&2
echo "- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] åž‹å®šç¾©ãŒé©åˆ‡ã‹" >&2
echo "- [ ] UIã®ä¸€è²«æ€§ãŒä¿ãŸã‚Œã¦ã„ã‚‹ã‹" >&2
echo "" >&2
echo "ã€ãƒã‚°ä¿®æ­£ã®å ´åˆã€‘" >&2
echo "- [ ] æ ¹æœ¬åŽŸå› ãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] åŒæ§˜ã®ãƒã‚°ãŒä»–ã«ãªã„ã‹" >&2
echo "- [ ] å›žå¸°ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹" >&2
echo "- [ ] å‰¯ä½œç”¨ãŒãªã„ã‹" >&2
echo "" >&2
echo "ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å ´åˆã€‘" >&2
echo "- [ ] å‹•ä½œãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹" >&2
echo "- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒåŠ£åŒ–ã—ã¦ã„ãªã„ã‹" >&2
echo "- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‹" >&2
echo "" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:" >&2
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
echo "- å•é¡ŒãŒã‚ã‚Œã°ä¿®æ­£æŒ‡ç¤ºã‚’ä½œæˆ" >&2
echo "- å•é¡Œãªã‘ã‚Œã°ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«å ±å‘Š" >&2
echo "" >&2

exit 0
