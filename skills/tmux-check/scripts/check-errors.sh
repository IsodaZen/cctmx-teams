#!/bin/bash
set -euo pipefail

# ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ã®ç¢ºèª
worker_info_file="${CLAUDE_PROJECT_DIR}/.claude/worker-info"
if [ ! -f "$worker_info_file" ]; then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
  echo "/tmux-worker ã‚¹ã‚­ãƒ«ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
  exit 1
fi

# ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
# shellcheck source=/dev/null
source "$worker_info_file"

if [ -z "${CLAUDE_WORKER_PANE:-}" ] || [ -z "${CLAUDE_WORKER_SESSION:-}" ]; then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³æƒ…å ±ãŒä¸æ­£ã§ã™" >&2
  echo "worker-infoã®å†…å®¹:" >&2
  cat "$worker_info_file" >&2
  exit 1
fi

session="${CLAUDE_WORKER_SESSION}"

# tmuxã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ§‹ç¯‰ï¼ˆsession:window.pane å½¢å¼ï¼‰
if [ -n "${CLAUDE_WORKER_WINDOW:-}" ]; then
  tmux_target="${session}:${CLAUDE_WORKER_WINDOW}.${CLAUDE_WORKER_PANE}"
elif [[ "${CLAUDE_WORKER_PANE}" == *.* ]]; then
  tmux_target="${session}:${CLAUDE_WORKER_PANE}"
else
  tmux_target="${session}:0.${CLAUDE_WORKER_PANE}"
fi

echo "ðŸ” ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..." >&2
echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${tmux_target}" >&2
echo "" >&2

# ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
if ! output=$(tmux capture-pane -t "${tmux_target}" -p -S -3000 2>&1); then
  echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒšã‚¤ãƒ³ã®å‡ºåŠ›ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
  echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${tmux_target}" >&2
  echo "$output" >&2
  exit 1
fi

# ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
error_lines=$(echo "$output" | grep -iE "(error|ã‚¨ãƒ©ãƒ¼|å¤±æ•—|exception|fatal)" || true)

if [ -n "$error_lines" ]; then
  echo "âš ï¸ ãƒ¯ãƒ¼ã‚«ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" >&2
  echo "" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "$error_lines" | tail -20
  echo "" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "ãƒªãƒ¼ãƒ€ãƒ¼ã®å¯¾å¿œãƒ•ãƒ­ãƒ¼:" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "1. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’åˆ†æž" >&2
  echo "   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹" >&2
  echo "   - ç™ºç”Ÿç®‡æ‰€ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã€è¡Œç•ªå·ï¼‰" >&2
  echo "   - ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹" >&2
  echo "" >&2
  echo "2. ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«å ±å‘Š" >&2
  echo "   - ã‚¨ãƒ©ãƒ¼è©³ç´°" >&2
  echo "   - æŽ¨å®šåŽŸå› " >&2
  echo "   - å½±éŸ¿ç¯„å›²" >&2
  echo "" >&2
  echo "3. ä¿®æ­£æ–¹é‡ã‚’ç›¸è«‡" >&2
  echo "   - ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ä¿®æ­£æ–¹é‡ã‚’è­°è«–" >&2
  echo "   - å¿…è¦ã«å¿œã˜ã¦è¦ä»¶ã‚’å†ç¢ºèª" >&2
  echo "" >&2
  echo "4. ãƒ¯ãƒ¼ã‚«ãƒ¼ã«å†æŒ‡ç¤º" >&2
  echo "   - ä¿®æ­£å†…å®¹ã‚’æ§‹é€ åŒ–æŒ‡ç¤ºãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã§é€ä¿¡" >&2
  echo "" >&2

  exit 1
fi

echo "âœ… ã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >&2
echo "" >&2
echo "ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚" >&2
echo "" >&2
echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:" >&2
echo "- ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã« /tmux-review ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½" >&2
echo "- å®šæœŸçš„ã« /tmux-check ã§ç›£è¦–ã‚’ç¶™ç¶š" >&2
echo "" >&2

exit 0
