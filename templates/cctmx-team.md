# tmuxを使ったClaudeCode多重起動開発ガイド

## 概要

このドキュメントでは、tmuxを使用してClaudeCodeを2つのペインで起動し、効率的な開発を行うための指針を提供します。

### 開発パターン

**リーダー・ワーカーパターン**を採用します:

- **リーダー（左ペイン）**: マネージャーからの指示を受け、タスクを分解・指示し、ワーカーの成果物をレビューする
- **ワーカー（右ペイン）**: リーダーの指示に従って具体的な作業を実行する

### 利点

- **並行作業**: リーダーは次のタスク計画を立てながら、ワーカーが実行
- **レビュー品質向上**: リーダーは批判的な視点でワーカーの成果物を評価
- **役割の明確化**: 指示側と実行側を分離することで責任範囲が明確
- **エラー早期検知**: リーダーがワーカーの状態を監視

### 自動化機能

- **Hook機能**: ClaudeCode起動時にtmux環境を自動判定・設定
- **スキル機能**: `/tmux-worker`, `/tmux-review`, `/tmux-check` で定型作業を効率化

---

## セットアップガイド

### 手動セットアップ

新規tmuxセッションを作成し、リーダー・ワーカー構成を構築します:

```bash
# 1. 新規tmuxセッションを作成
tmux new-session -s claude-dev

# 2. 左ペイン（リーダー）でClaudeCodeを起動
claude

# 3. 右側に垂直分割でワーカーペインを作成
# リーダーのClaudeCode内で実行:
# /tmux-worker スキルを使用
# または手動で: Ctrl+B → % （tmuxのキーバインド）

# 4. ワーカーペインでClaudeCodeを起動
# tmux send-keys -t claude-dev:0.1 "claude" Enter
```

### 自動セットアップ（Hook機能）

SessionStart Hookを設定すると、ClaudeCode起動時に自動でtmux環境を判定・設定します。

**Hook設定は Phase 2 で実装します。**

---

## Hook機能の詳細

### SessionStart Hook

ClaudeCode起動時に以下を自動実行:

1. tmux内部で起動されたか判定（`$TMUX` 環境変数の確認）
2. tmux内部の場合:
   - セッション名とペイン番号を取得
   - 環境変数に保存（`$CLAUDE_TMUX_SESSION`, `$CLAUDE_TMUX_PANE`, `$CLAUDE_ROLE`）
3. tmux外部の場合:
   - 警告メッセージを表示

### 環境変数

- `CLAUDE_TMUX_SESSION`: tmuxセッション名（例: `claude-dev`）
- `CLAUDE_TMUX_PANE`: 現在のペイン番号（例: `0.0`）
- `CLAUDE_ROLE`: 役割（`leader` または `worker`）
- `CLAUDE_WORKER_PANE`: ワーカーペイン番号（リーダーが設定）

---

## スキル機能の詳細

### `/tmux-worker` - ワーカーペイン作成

リーダーが新しいワーカーペインを作成し、ClaudeCodeを起動します。

**使用タイミング:**

- タスクをワーカーに委譲したいとき
- 初回セットアップ時

**動作:**

1. 右側に垂直分割でペインを作成
2. ワーカーペインでClaudeCodeを起動
3. ワーカーペイン番号を環境変数に保存

**使用例:**

```bash
/tmux-worker
```

その後、リーダーは構造化指示をワーカーに送信します（後述）。

### `/tmux-review` - レビュー実行

ワーカーの出力を取得し、成果物をレビューします。

**使用タイミング:**

- ワーカーがタスク完了を報告したとき
- 定期的な進捗確認時

**動作:**

1. ワーカーペインの出力をキャプチャ（スクロールバック含む）
2. 一時ファイルに保存
3. 出力を表示

**使用例:**

```bash
/tmux-review
```

レビュー後、レビューチェックリスト（後述）に従って評価します。

### `/tmux-check` - エラー検知

ワーカーの出力からエラーを検知します。

**使用タイミング:**

- ワーカーが応答しないとき
- 定期的なヘルスチェック時

**動作:**

1. ワーカーペインの出力をキャプチャ
2. エラーパターンを検索（`error`, `エラー`, `失敗`, `exception`, `fatal`）
3. 検出された場合、エラーメッセージを表示

**使用例:**

```bash
/tmux-check
```

---

## 役割定義

### リーダー（左ペイン）の責務

リーダーは**マネージャー**として振る舞います:

#### 1. タスク分解と不明点のヒアリング

- マネージャー（人間）からの指示を受ける
- タスクを実行可能な単位に分解
- 不明点や判断基準が不明瞭な点を積極的にヒアリング
- 要件・制約・成果物の明確化

#### 2. ワーカーへの詳細な作業指示

- 構造化指示フォーマット（後述）を使用
- 目的、要件、制約、成果物、完了条件を明示
- 曖昧さを排除した具体的な指示

#### 3. ワーカーの起動と管理

- `/tmux-worker` スキルでワーカーペインを作成
- tmux send-keys でワーカーに指示を送信
- ワーカーの状態監視

#### 4. 成果物の批判的レビュー

- `/tmux-review` スキルでワーカーの出力を確認
- レビューチェックリスト（後述）に従って評価
- 妥協せず、問題があれば修正指示

#### 5. エラー検知と報告

- `/tmux-check` スキルでエラーを検知
- エラー内容、発生箇所、推定原因を分析
- マネージャーに報告し、修正方針を相談

#### 6. タスク実行の委譲

- **リーダー自身はタスク実行を行わない**
- すべての実装作業はワーカーに委譲
- リーダーは指示・レビュー・報告に専念

### リーダーの禁止事項

リーダーは以下の作業を**絶対に行ってはいけません**:

#### 実装作業の禁止

- **コード実装**: 関数、コンポーネント、クラスなどの実装
- **ファイル編集**: コードファイル、設定ファイルの直接編集
- **ファイル作成**: 新規ファイルの作成
- **テスト実装**: ユニットテスト、統合テストの作成
- **デバッグ実行**: エラー修正のためのコード変更

#### 例外

以下の場合のみ、マネージャー（人間）の明示的な許可があれば実装作業が可能:

- ワーカーが権限制限で作業できない場合
- 緊急対応が必要な場合
- ワーカーが長時間応答せず、タスクが停滞している場合

**原則**: リーダーは**指示・レビュー・報告**に専念し、実装はワーカーに委譲する

### ワーカー（右ペイン）の責務

ワーカーは**実行者**として振る舞います:

#### 1. 指示に従った作業実行

- リーダーから送られた構造化指示を読み取る
- 要件・制約を守って実装

#### 2. 作業結果の報告

- タスク完了時に報告
- 成果物の説明

#### 3. 不明点の確認

- 指示が不明瞭な場合は質問（実際にはリーダーがヒアリングすべき）

### ワーカーの禁止事項

ワーカーは以下の作業を**絶対に行ってはいけません**:

#### 管理業務の禁止

- **タスク分解**: タスクを細分化して計画を立てる
- **要件ヒアリング**: マネージャーに不明点を質問する
- **レビュー実行**: 自分や他のワーカーの成果物をレビューする
- **エラー分析**: エラーの根本原因を分析してマネージャーに報告する
- **方針決定**: 実装方法、技術選定、アーキテクチャの決定

#### 指示外の作業の禁止

- **追加機能の実装**: 指示にない機能を勝手に追加する
- **リファクタリング**: 指示されていないコードの改善
- **ドキュメント作成**: README、ガイドラインの作成（指示がある場合を除く）
- **設定変更**: 指示されていない設定ファイルの変更

#### 独自判断の禁止

- **技術選定**: 使用するライブラリ、フレームワークの選択
- **設計変更**: アーキテクチャ、データ構造の変更
- **品質基準の判断**: 「これで十分」という独自の品質判断

#### Git操作の禁止（情報参照を除く）

ワーカーによる破壊的なGit操作を禁止します。これらはリーダーの承認なしに実行してはいけません。

**禁止するGit操作**:

- **git commit**: コミットの作成（リーダーが成果物をレビュー・承認してから実施すべき）
- **git push**: リモートリポジトリへのプッシュ
- **git merge**: ブランチのマージ
- **git rebase**: コミット履歴の書き換え
- **git reset**: コミットの取り消し
- **git checkout**: ブランチの切り替え、ファイルの復元
- **git add**: ステージングエリアへの追加
- **git stash apply**: 退避した変更の適用
- **git cherry-pick**: コミットの選択的適用
- **git config**: Git設定の変更

**許可するGit操作**（情報参照のみ）:

- **git status**: 作業ツリーの状態確認
- **git log**: コミット履歴の確認
- **git diff**: 差分の確認
- **git show**: コミット内容の確認
- **git branch**: ブランチ一覧の表示（-lオプション等）
- **git blame**: 行ごとの変更履歴確認

**禁止理由**:

1. **レビュー前のコミット禁止**: リーダーのレビューを経ずにコミットすると、問題のあるコードが履歴に残る
2. **リポジトリの整合性**: ワーカーが独自判断でブランチ操作やマージを行うと、リポジトリが混乱する
3. **変更の追跡**: すべてのGit操作はリーダーが一元管理し、変更履歴の品質を保つ

**原則**: ワーカーは**指示に忠実に従い、実装に専念**する。判断が必要な場合はリーダーに確認を求める（ただし、実際にはリーダーが事前に明確な指示を出すべき）

---

## 構造化指示フォーマット

リーダーがワーカーに送る指示は、以下のフォーマットを使用します:

```text
タスクID: TASK-YYYYMMDD-XXX
目的: [このタスクで達成したいこと]

要件:
- [要件1]
- [要件2]
- [要件3]

制約:
- [制約1: 例) 既存のXXXインターフェースを変更しない]
- [制約2: 例) TypeScriptの型安全性を保つ]

成果物:
- [成果物1: 例) src/components/UserProfile.tsx]
- [成果物2: 例) src/types/user.ts の更新]

完了条件:
- [条件1: 例) npm run build が成功する]
- [条件2: 例) eslint エラーがない]
- [条件3: 例) 既存テストが通る]
```

### フォーマット使用例

```text
タスクID: TASK-20260205-001
目的: ユーザープロフィール表示コンポーネントの作成

要件:
- ユーザー名、メールアドレス、アバター画像を表示
- プロップスで User 型オブジェクトを受け取る
- レスポンシブデザイン（モバイル対応）

制約:
- Material-UI コンポーネントを使用
- 既存の User 型定義を変更しない
- アクセシビリティ対応（ARIA属性）

成果物:
- ksa/webroot/react-app/src/components/UserProfile.tsx
- ksa/webroot/react-app/src/components/UserProfile.test.tsx

完了条件:
- TypeScript型エラーがない
- ESLintエラーがない
- npm run build が成功
- テストが通る（npm test）
```

---

## tmuxコマンドリファレンス

リーダーが使用する主要なtmuxコマンドです。

### セッション作成

```bash
tmux new-session -s claude-dev
```

新しいtmuxセッションを `claude-dev` という名前で作成します。

### ペイン分割（垂直分割）

```bash
tmux split-window -h -t claude-dev:0
```

現在のウィンドウを垂直に分割します（左右に分かれる）。

**キーバインド**: `Ctrl+B` → `%`

### ワーカーペインでClaudeCode起動

```bash
tmux send-keys -t claude-dev:0.1 "cd /Users/z-isoda/develop/smart-address-book/git/docker.ksa2.kddi.ne.jp" Enter
tmux send-keys -t claude-dev:0.1 "claude" Enter
```

**ペイン指定**: `-t セッション名:ウィンドウ番号.ペイン番号`

- `claude-dev:0.0` = 左ペイン（リーダー）
- `claude-dev:0.1` = 右ペイン（ワーカー）

### ワーカーに指示を送信

```bash
# 指示内容を送信（Enterは送らない）
tmux send-keys -t claude-dev:0.1 "タスクID: TASK-20260205-001
目的: ユーザープロフィール表示コンポーネントの作成
..."

# Enterキーを送信して実行
tmux send-keys -t claude-dev:0.1 Enter
```

**重要**: 指示内容の送信とEnterキーの送信は**別々に実行**します。

### ワーカーの出力を確認

```bash
# ペイン全体をキャプチャ
tmux capture-pane -t claude-dev:0.1 -p

# スクロールバック含めてキャプチャ（過去3000行）
tmux capture-pane -t claude-dev:0.1 -p -S -3000
```

**オプション**:

- `-p`: 標準出力に表示
- `-S -3000`: スクロールバックを3000行遡る

### ペイン間の移動

```bash
# 左ペイン（リーダー）に移動
tmux select-pane -t claude-dev:0.0

# 右ペイン（ワーカー）に移動
tmux select-pane -t claude-dev:0.1
```

**キーバインド**: `Ctrl+B` → `←` または `→`

### ペイン一覧表示

```bash
tmux list-panes -t claude-dev:0
```

現在のウィンドウのすべてのペインを表示します。

---

## エラー検知機能

リーダーはワーカーのエラーを早期に検知し、マネージャーに報告する責任があります。

### エラーパターン

以下のキーワードを含む出力をエラーとして検知します:

- `Error:`
- `エラー`
- `失敗`
- `Exception`
- `Fatal`
- ClaudeCodeの異常終了メッセージ

### 検知方法

`/tmux-check` スキルを使用してエラーを検知します:

```bash
/tmux-check
```

手動で検知する場合:

```bash
# ワーカーの出力をキャプチャしてエラーチェック
output=$(tmux capture-pane -t claude-dev:0.1 -p -S -3000)
if echo "$output" | grep -iE "(error|エラー|失敗|exception|fatal)"; then
    echo "⚠️ ワーカーでエラーが発生している可能性があります"
fi
```

### リーダーの対応フロー

1. **エラー内容を分析**
   - エラーメッセージの内容
   - 発生箇所（ファイル、行番号）
   - スタックトレース

2. **マネージャーに報告**
   - エラー詳細
   - 推定原因
   - 影響範囲

3. **修正方針を相談**
   - マネージャーと修正方針を議論
   - 必要に応じて要件を再確認

4. **ワーカーに再指示**
   - 修正内容を構造化指示フォーマットで送信

### タイムアウト検知

ワーカーが長時間応答しない場合もエラーとみなします:

- 目安: 5分以上応答がない場合
- 対応: `/tmux-check` でエラー確認 → 必要に応じてペインを再起動

---

## レビューチェックリスト

リーダーはワーカーの成果物を以下のチェックリストで評価します。

### 共通チェック項目

- [ ] タスクの目的が達成されているか
- [ ] 要件がすべて満たされているか
- [ ] 制約条件が守られているか
- [ ] コードの品質（可読性、保守性）は適切か
- [ ] エラーハンドリングが適切に実装されているか
- [ ] テストが必要な場合、テストが実装されているか
- [ ] TypeScript型エラーがないか
- [ ] ESLintエラーがないか
- [ ] ビルドが成功するか（`npm run build`）

### タスクタイプ別チェック項目

#### 機能追加の場合

- [ ] 既存機能への影響がないか（回帰テスト）
- [ ] ドキュメント（コメント、README）が更新されているか
- [ ] 型定義が適切か（any型の乱用がないか）
- [ ] UIの一貫性が保たれているか（デザインシステムに準拠）
- [ ] アクセシビリティが考慮されているか（ARIA属性）
- [ ] パフォーマンスへの影響はないか

#### バグ修正の場合

- [ ] 根本原因が解決されているか（対症療法になっていないか）
- [ ] 同様のバグが他の箇所にないか
- [ ] 回帰テストが追加されているか
- [ ] 副作用（意図しない動作変更）がないか
- [ ] エッジケースが考慮されているか

#### リファクタリングの場合

- [ ] 動作が変わっていないか（振る舞いの保存）
- [ ] パフォーマンスが劣化していないか
- [ ] すべてのテストが通るか
- [ ] 依存関係が整理されているか
- [ ] コードの重複が削減されているか
- [ ] 命名が改善されているか

### レビューの実施方法

1. `/tmux-review` スキルでワーカーの出力を取得
2. 成果物ファイルを直接確認（Read tool）
3. チェックリストに従って評価
4. 問題があれば、具体的な修正指示を作成
5. 問題なければ、マネージャーに報告

---

## 運用フロー

実際の開発フローは以下の通りです:

```text
1. マネージャー（人間）がリーダーに指示
   「ユーザープロフィール表示機能を追加してほしい」
   ↓
2. リーダーがタスク分解・不明点をヒアリング
   「表示する項目は?」「デザインの指定は?」「既存のUser型を使う?」
   ↓
3. リーダーが構造化指示を作成
   タスクID、目的、要件、制約、成果物、完了条件を明記
   ↓
4. リーダーがワーカーペインを作成・ClaudeCode起動
   /tmux-worker スキルを使用
   ↓
5. リーダーが tmux send-keys でワーカーに指示送信
   構造化指示フォーマットに従って送信
   ↓
6. ワーカーが作業実行
   コンポーネント実装、テスト作成、ビルド確認
   ↓
7. ワーカーがタスク完了を報告
   「UserProfile.tsxを作成しました。ビルドとテストが通りました。」
   ↓
8. リーダーが /tmux-review で出力確認
   ワーカーの出力全体をキャプチャ
   ↓
9. リーダーが /tmux-check でエラー検知チェック実施
   エラーパターンを検索
   ↓
10. リーダーがレビューチェックリストで成果物を評価
    - コードの品質
    - 要件充足
    - 制約遵守
    ↓
11. 問題があれば修正指示（5に戻る）
    問題なければマネージャーに報告
    「ユーザープロフィール表示機能を実装しました。レビュー完了です。」
```

---

## ベストプラクティス

### リーダーの心得

1. **一度に一つのタスク**
   - リーダーは一度に複数のタスクを並行してワーカーに割り当てない
   - 一つのタスクが完了してから次のタスクを開始

2. **明確で具体的な指示**
   - 構造化指示フォーマットを必ず使用
   - 曖昧な表現を避ける
   - 判断が必要な箇所はマネージャーにヒアリング

3. **批判的なレビュー**
   - 妥協せず、問題があれば必ず指摘
   - 「動けばいい」ではなく、品質を追求
   - レビューチェックリストを活用

4. **早期エラー検知**
   - 定期的に `/tmux-check` で監視
   - ワーカーが長時間応答しない場合は確認

5. **明確な完了基準**
   - タスクの完了条件を明示
   - ワーカーが「完了」と言っても、リーダーが最終判断

### ワーカーへの指示のコツ

- **具体的な成果物**: 「コンポーネントを作成」ではなく「src/components/UserProfile.tsxを作成」
- **完了条件を明示**: 「ビルドが成功すること」「ESLintエラーがないこと」
- **制約を明確に**: 「既存のUser型を変更しない」「Material-UIを使用」

### レビューの観点

- **コードの意図**: なぜこの実装なのか?
- **エッジケース**: 異常系は考慮されているか?
- **パフォーマンス**: 無駄な処理はないか?
- **保守性**: 将来の変更に強いか?

---

## トラブルシューティング

### ワーカーが応答しない

**原因**: ClaudeCodeがフリーズしている、またはタスクが長時間実行中

**対処法**:

1. `/tmux-check` でエラーを確認
2. エラーがある場合は分析・報告
3. エラーがない場合は待機（長時間の場合は再起動）
4. 再起動する場合:

   ```bash
   tmux kill-pane -t claude-dev:0.1
   /tmux-worker
   ```

### ペイン番号がわからない

**原因**: ペイン番号は動的に変わる

**対処法**:

```bash
tmux list-panes -t claude-dev:0
```

すべてのペイン一覧を表示。番号、サイズ、実行中のコマンドが確認できます。

### 指示が正しく送信されない

**原因**: send-keys で長い文字列を一度に送ると失敗することがある

**対処法**:
指示内容の送信とEnterキーの送信を**別々に実行**:

```bash
# 1. 指示内容を送信（Enterなし）
tmux send-keys -t claude-dev:0.1 "タスクID: TASK-20260205-001..."

# 2. Enterキーを送信
tmux send-keys -t claude-dev:0.1 Enter
```

### Hook設定が反映されない

**原因**: Hook設定変更後にClaudeCodeを再起動していない

**対処法**:

```bash
# ClaudeCodeを終了
exit

# 再起動
claude
```

### ワーカーペイン番号が変わる

**原因**: ペインを削除・再作成すると番号が変わる

**対処法**:
`/tmux-worker` スキルは常に最新のワーカーペイン番号を `.claude/worker-info` に保存します。手動で確認する場合:

```bash
cat .claude/worker-info
```

---

## まとめ

このドキュメントでは、tmuxを使ってClaudeCodeを多重起動し、リーダー・ワーカーパターンで効率的に開発する方法を説明しました。

### 重要ポイント

1. **役割分担**: リーダーは指示・レビュー、ワーカーは実行
2. **構造化指示**: 明確なフォーマットで指示を送る
3. **批判的レビュー**: 妥協せず、品質を追求
4. **エラー早期検知**: `/tmux-check` で定期的に監視
5. **スキル活用**: `/tmux-worker`, `/tmux-review`, `/tmux-check` で効率化

### 次のステップ

- **Phase 2**: Hook機能の実装（SessionStart Hookによる自動化）
- **Phase 3**: スキル機能の実装（`/tmux-worker`, `/tmux-review`, `/tmux-check`）

これらの機能により、tmux多重起動開発がさらに効率的になります。
